<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>éšœå®³ç‰©ã‚³ãƒ¬ã‚¯ã‚¿ãƒ¼</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.8.0/p5.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.1.3/socket.io.js"></script>
    <style>
      body {
        font-family: sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      #game-info {
        display: flex;
        justify-content: space-between;
        width: 500px;
        font-size: 1.2em;
        margin-bottom: 10px;
      }
      #controls {
        margin-top: 10px;
      }
      button {
        padding: 10px 20px;
        font-size: 1em;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <h1>éšœå®³ç‰©ã‚³ãƒ¬ã‚¯ã‚¿ãƒ¼</h1>
    <div>
      <div>ã‚ãªãŸã®ID: <span id="myid"></span></div>
      <div>ã‚¹ãƒãƒ›ã§<a href="/smart.html" target="_blank">ã“ã¡ã‚‰ã®ãƒšãƒ¼ã‚¸</a>ã‚’é–‹ãã€ã€Œæ¥ç¶šã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦æ“ä½œã—ã¦ãã ã•ã„ã€‚</div>
      <div>ç”»é¢ã«è¡¨ç¤ºã•ã‚ŒãŸğŸ”´ã‚’æ™‚é–“ã¾ã§ã«é›†ã‚ã¦ãã ã•ã„</div>
    </div>

    <div id="game-info">
      <div>ã‚¹ã‚³ã‚¢: <span id="score">0</span></div>
      <div>æ®‹ã‚Šæ™‚é–“: <span id="timer">20</span></div>
    </div>

    <div id="canvas-container"></div>

    <div id="controls">
      <button id="start-btn">ã‚²ãƒ¼ãƒ é–‹å§‹</button>
      <button id="restart-btn" style="display: none;">ã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤</button>
    </div>

    <script>
      const socket = io.connect();

      // --- å¤‰æ•°å®šç¾© ---
      let myid = sessionStorage.getItem('clientId');
      if (!myid) {
        myid = Math.random().toString(36).substring(2, 15);
        sessionStorage.setItem('clientId', myid);
      }

      // ã‚»ãƒ³ã‚µãƒ¼ãƒ‡ãƒ¼ã‚¿
      let g = 0; // gamma (å·¦å³)
      let b = 0; // beta (å‰å¾Œ)

      // ã‚²ãƒ¼ãƒ çŠ¶æ…‹
      let gameStarted = false;
      let gameOver = false;
      const GAME_DURATION = 20; // ã‚²ãƒ¼ãƒ æ™‚é–“ï¼ˆç§’ï¼‰
      let timeLeft = GAME_DURATION;
      let score = 0;
      let startTime;

      // ã‚²ãƒ¼ãƒ ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
      let player;
      let obstacles = [];
      const NUM_OBSTACLES = 5;

      // DOMè¦ç´ 
      const myIdSpan = document.querySelector("#myid");
      const startBtn = document.querySelector("#start-btn");
      const restartBtn = document.querySelector("#restart-btn");
      const scoreSpan = document.querySelector("#score");
      const timerSpan = document.querySelector("#timer");

      // --- åˆæœŸè¨­å®š ---
      myIdSpan.innerHTML = myid;

      startBtn.addEventListener("click", () => {
        socket.emit("join", "game");
        gameStarted = true;
        gameOver = false;
        startTime = millis();
        startBtn.style.display = "none";
        loop(); // p5.jsã®æç”»ãƒ«ãƒ¼ãƒ—ã‚’é–‹å§‹
      });

      restartBtn.addEventListener("click", () => {
        resetGame();
        restartBtn.style.display = "none";
        startBtn.style.display = "block";
      });

      socket.on("sensor", (data) => {
        g = parseFloat(data.g);
        b = parseFloat(data.b);
      });

      // --- p5.js ---
      function setup() {
        const canvas = createCanvas(500, 500);
        canvas.parent('canvas-container');
        player = { x: width / 2, y: height / 2, size: 30 };
        for (let i = 0; i < NUM_OBSTACLES; i++) {
          obstacles.push({ x: random(width), y: random(height), size: 20 });
        }
        textAlign(CENTER, CENTER);
        textSize(32);
        noLoop(); // ã‚²ãƒ¼ãƒ é–‹å§‹ã¾ã§æç”»ã‚’åœæ­¢
      }

      function draw() {
        if (!gameStarted) {
          background(220);
          text("ã€Œã‚²ãƒ¼ãƒ é–‹å§‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„", width / 2, height / 2);
          return;
        }

        background(240);

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ›´æ–°ã¨æç”»
        player.x += g * 0.2;
        player.y += b * 0.2;
        player.x = constrain(player.x, 0, width); // ç”»é¢å¤–ã«å‡ºãªã„ã‚ˆã†ã«
        player.y = constrain(player.y, 0, height);
        fill(0, 100, 255);
        noStroke();
        ellipse(player.x, player.y, player.size, player.size);

        // éšœå®³ç‰©ã®æç”»ã¨å½“ãŸã‚Šåˆ¤å®š
        for (let obs of obstacles) {
          fill(255, 0, 0);
          ellipse(obs.x, obs.y, obs.size, obs.size);
          if (dist(player.x, player.y, obs.x, obs.y) < (player.size + obs.size) / 2) {
            score++;
            scoreSpan.textContent = score;
            obs.x = random(width);
            obs.y = random(height);
          }
        }

        // ã‚¿ã‚¤ãƒãƒ¼æ›´æ–°
        timeLeft = GAME_DURATION - (millis() - startTime) / 1000;
        if (timeLeft <= 0) {
          timeLeft = 0;
          gameOver = true;
          gameStarted = false;
          noLoop(); // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ã§æç”»åœæ­¢
          background(100);
          fill(255);
          text(`ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ï¼\nã‚¹ã‚³ã‚¢: ${score}`, width / 2, height / 2);
          restartBtn.style.display = "block";
        }
        timerSpan.textContent = Math.ceil(timeLeft);
      }

      function resetGame() {
        score = 0;
        timeLeft = GAME_DURATION;
        scoreSpan.textContent = score;
        timerSpan.textContent = timeLeft;
        player.x = width / 2;
        player.y = height / 2;
        for (let obs of obstacles) {
          obs.x = random(width);
          obs.y = random(height);
        }
        redraw(); // åˆæœŸçŠ¶æ…‹ã‚’ä¸€åº¦æç”»
      }
    </script>
  </body>
</html>
